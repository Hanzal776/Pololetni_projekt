<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hern칤 Sk칩re</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
{% import 'macros.html' as macros %}
    <div class="container">
        <h1>游꿡 Po캜칤t치n칤 Hern칤ho Sk칩re</h1>

        <div class="content">
            <!-- Panel pro p콏id치n칤 hr치캜e -->
            <div class="card">
                <h2>P콏idat Hr치캜e</h2>
                {{ macros.message_div('playerMessage') }}
                <form id="addPlayerForm">
                    {{ macros.form_group('Jm칠no hr치캜e', 'playerName', 'text', true, 'Zadejte jm칠no hr치캜e', None, '[a-zA-Z0-9 \-_]+') }}
                    {{ macros.button('P콏idat hr치캜e', 'submit') }}
                </form>

                <h3 style="margin-top: 25px; color: #333;">Hr치캜i:</h3>
                <ul id="playersList" class="player-list"></ul>
            </div>

            <!-- Panel pro p콏id치n칤 sk칩re -->
            <div class="card">
                <h2>Zaznamenat Sk칩re</h2>
                {{ macros.message_div('scoreMessage') }}
                <form id="addScoreForm">
                    <div class="form-group">
                        <label for="playerSelect">Vyberte hr치캜e:</label>
                        <select id="playerSelect" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;" required>
                            <option value="">-- Vyberte hr치캜e --</option>
                        </select>
                    </div>
                    {{ macros.form_group('Sk칩re', 'scoreValue', 'number', true, 'Zadejte sk칩re', None, None, '0') }}
                    {{ macros.form_group('Pozn치mka (voliteln칠)', 'scoreNotes', 'text', false, 'Voliteln치 pozn치mka', 2) }}
                    {{ macros.button('Zaznamenat sk칩re', 'submit') }}
                </form>
            </div>

            <!-- Leaderboard -->
            <div class="card leaderboard">
                <h2>游끥 Leaderboard</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Po콏ad칤</th>
                            <th>Hr치캜</th>
                            <th>Celkov칠 Sk칩re</th>
                            <th>Po캜et Her</th>
                            <th>Pr콢m캩r</th>
                        </tr>
                    </thead>
                    <tbody id="leaderboardBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Zv칳코it sk칩re hr치캜e
        async function loadPlayers() {
            try {
                const response = await fetch('/api/players');
                const players = await response.json();
                
                // Aktualizovat seznam hr치캜콢
                const playersList = document.getElementById('playersList');
                playersList.innerHTML = '';
                players.forEach(player => {
                    const li = document.createElement('li');
                    li.className = 'player-item';
                    li.innerHTML = `
                        <div class="player-info">
                            <div class="player-name">${player.name}</div>
                            <small>Sk칩re: ${player.total_score} | Her: ${player.games_played}</small>
                        </div>
                        <div class="actions">
                            <button class="delete" onclick="deletePlayer(${player.id})">Smazat</button>
                        </div>
                    `;
                    playersList.appendChild(li);
                });

                // Aktualizovat select
                const playerSelect = document.getElementById('playerSelect');
                playerSelect.innerHTML = '<option value="">-- Vyberte hr치캜e --</option>';
                players.forEach(player => {
                    const option = document.createElement('option');
                    option.value = player.id;
                    option.textContent = player.name;
                    playerSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Chyba p콏i na캜칤t치n칤 hr치캜콢:', error);
            }
        }

        async function loadLeaderboard() {
            try {
                const response = await fetch('/api/leaderboard');
                const players = await response.json();
                
                const leaderboardBody = document.getElementById('leaderboardBody');
                leaderboardBody.innerHTML = '';
                
                const medals = ['gold', 'silver', 'bronze'];
                players.forEach((player, index) => {
                    const tr = document.createElement('tr');
                    const medalClass = index < 3 ? medals[index] : '';
                    const medalHTML = medalClass ? `<span class="medal ${medalClass}">${index + 1}</span>` : `<span>${index + 1}</span>`;
                    
                    tr.innerHTML = `
                        <td>${medalHTML}</td>
                        <td>${player.name}</td>
                        <td>${player.total_score}</td>
                        <td>${player.games_played}</td>
                        <td>${player.average_score}</td>
                    `;
                    leaderboardBody.appendChild(tr);
                });
            } catch (error) {
                console.error('Chyba p콏i na캜칤t치n칤 leaderboardu:', error);
            }
        }

        async function deletePlayer(playerId) {
            if (!confirm('Opravdu chcete smazat tohoto hr치캜e?')) return;
            
            try {
                await fetch(`/api/players/${playerId}`, { method: 'DELETE' });
                loadPlayers();
                loadLeaderboard();
            } catch (error) {
                console.error('Chyba p콏i maz치n칤 hr치캜e:', error);
            }
        }

        // Formul치콏 pro p콏id치n칤 hr치캜e
        document.getElementById('addPlayerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('playerName').value;
            
            try {
                const response = await fetch('/api/players', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name })
                });
                
                const messageDiv = document.getElementById('playerMessage');
                if (response.ok) {
                    messageDiv.innerHTML = '<div class="success">Hr치캜 byl 칰sp캩코n캩 p콏id치n!</div>';
                    document.getElementById('playerName').value = '';
                    loadPlayers();
                    loadLeaderboard();
                    setTimeout(() => messageDiv.innerHTML = '', 3000);
                } else {
                    const error = await response.json();
                    messageDiv.innerHTML = `<div class="error">${error.error}</div>`;
                    setTimeout(() => messageDiv.innerHTML = '', 3000);
                }
            } catch (error) {
                console.error('Chyba:', error);
            }
        });

        // Formul치콏 pro p콏id치n칤 sk칩re
        document.getElementById('addScoreForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const playerId = document.getElementById('playerSelect').value;
            const score = parseInt(document.getElementById('scoreValue').value);
            const notes = document.getElementById('scoreNotes').value;
            
            try {
                const response = await fetch('/api/scores', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ player_id: playerId, score, notes })
                });
                
                const messageDiv = document.getElementById('scoreMessage');
                if (response.ok) {
                    messageDiv.innerHTML = '<div class="success">Sk칩re bylo 칰sp캩코n캩 zaznamen치no!</div>';
                    document.getElementById('scoreValue').value = '';
                    document.getElementById('scoreNotes').value = '';
                    document.getElementById('playerSelect').value = '';
                    loadPlayers();
                    loadLeaderboard();
                    setTimeout(() => messageDiv.innerHTML = '', 3000);
                } else {
                    const error = await response.json();
                    messageDiv.innerHTML = `<div class="error">${error.error}</div>`;
                    setTimeout(() => messageDiv.innerHTML = '', 3000);
                }
            } catch (error) {
                console.error('Chyba:', error);
            }
        });

        // Po캜치te캜n칤 na캜ten칤
        loadPlayers();
        loadLeaderboard();

        // Aktualizovat data ka쬯칳ch 5 sekund
        setInterval(() => {
            loadLeaderboard();
        }, 5000);
    </script>
</body>
</html>
